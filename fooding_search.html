<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹ì¬ë£Œ ê²€ìƒ‰ - Fooding</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
    />
    <link rel="stylesheet" href="common.css" />
    <link rel="stylesheet" href="fooding_search.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <header>
      <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
      <nav class="navbar">
        <div class="container">
          <a href="fooding_dashboard.html" class="logo">í‘¸ë”©</a>
          <ul class="nav-links">
            <li><a href="fooding_dashboard.html">ëŒ€ì‹œë³´ë“œ</a></li>
            <li>
              <a href="fooding_search.html" class="active">ì‹ì¬ë£Œ ê²€ìƒ‰</a>
            </li>
            <li><a href="fooding_new-item.html">ì‹ì¬ë£Œ ë“±ë¡</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <div class="exchange-container">
        <div class="exchange-box">
          <h2>ì‹ì¬ë£Œ ê²€ìƒ‰</h2>
          <p class="subtitle">ì›í•˜ëŠ” ì‹ì¬ë£Œë¥¼ ê²€ìƒ‰í•˜ì—¬ êµí™˜ ì‹ ì²­í•´ë³´ì„¸ìš”</p>

          <div class="search-group">
            <input
              type="text"
              id="search-input"
              placeholder="ì°¾ìœ¼ì‹œëŠ” ì‹ì¬ë£Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
            <button class="search-btn" id="search-btn">ğŸ”</button>
          </div>
          <button id="back-btn" class="back-btn hidden">ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
        <div id="item-list" class="item-list"></div>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const itemListEl = document.getElementById('item-list');
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const backBtn = document.getElementById('back-btn');

        let allItems = []; // API ë°ì´í„° ìºì‹±
        let isLoaded = false;

        // ì´ˆê¸° API ìš”ì²­ (1ë²ˆë§Œ)
        if (!isLoaded) {
          axios
            .get('https://3.37.172.142:8081/api/items')
            .then((response) => {
              allItems = response.data;
              isLoaded = true;
            })
            .catch((error) => {
              console.error('ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', error);
              itemListEl.innerHTML =
                '<p>ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>';
            });
        }

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í•„í„°ë§
        searchBtn.addEventListener('click', handleSearch);

        // ì—”í„°í‚¤ ê²€ìƒ‰ ê°€ëŠ¥
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSearch();
          }
        });

        backBtn.addEventListener('click', () => {
          itemListEl.innerHTML = '';
          searchInput.value = '';
          backBtn.classList.add('hidden');
        });

        // ê²€ìƒ‰ í•¨ìˆ˜
        function handleSearch() {
          const keyword = searchInput.value.trim();
          if (!keyword) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          searchItems(keyword);
        }

        // í•„í„°ë§
        function searchItems(keyword) {
          if (allItems.length === 0) {
            alert('ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          const filtered = allItems.filter((item) =>
            item.itemName.includes(keyword)
          );
          renderItems(filtered);
        }

        // ë Œë”ë§
        function renderItems(items) {
          itemListEl.innerHTML = '';

          if (items.length === 0) {
            backBtn.classList.add('hidden');
            itemListEl.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }

          backBtn.classList.remove('hidden');

          items.forEach((item) => {
            const imageUrl = item.thumbnailUrl || 'default.jpeg'; // null-safe ì²˜ë¦¬

            const itemCard = document.createElement('div');
            itemCard.className = 'item-card';
            itemCard.innerHTML = `
              <div class="item-header">
                <strong>${item.itemName}</strong>
                <span class="badge">${
                  item.itemStatus === 'SHARE' ? 'ë‚˜ëˆ”' : 'êµí™˜'
                }</span>
              </div>
              <div class="item-image">
                <img src="${imageUrl}" alt="${
              item.itemName
            }" onerror="this.src='noimage.png'">
              </div>
              <div class="item-category">${
                item.categoryName || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'
              }</div>
              <p>${item.itemDescription}</p>
              <p><strong>${item.quantity}</strong></p>
              <p>ğŸ“… ìœ í†µê¸°í•œ: ${item.expirationDate}</p>
              <p>ğŸ“ ${item.itemLocation}</p>
              <p>ğŸ‘¤ ${item.registeredBy || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
              <button class="contact-btn">ì—°ë½í•˜ê¸°</button>
            `;
            itemListEl.appendChild(itemCard);
          });
        }
      });
    </script>
  </body>
</html>
